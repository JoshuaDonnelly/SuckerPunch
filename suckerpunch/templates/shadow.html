{% extends "base.html" %}

{% block title %}Shadow Boxing Session | SuckerPunch{% endblock %}

{% block content %}

<div class="relative h-[45vh] pt-48">
   <h1 class="text-4xl font-extrabold mb-4 pb-2 text-center">
        {{ title }}
    </h1>
    <h2 class="text-lg text-white-600 max-w-xl mx-auto mb-8 text-center">
        {{ desc }}
    </h2>
    <h2 class="text-lg text-white-600 max-w-xl mx-auto mb-8 text-center">
        ðŸ¥ŠFocus -> {{ focus }}
    </h2>
</div>
<div
    id="session-data"
    data-title="{{ title }}"
    data-desc="{{ desc }}"
    data-focus="{{ focus }}"
    data-duration="{{ duration }}"
    class="hidden">
</div>

<div class="mt-6 flex flex-col items-center gap-4">
    <div class="flex items-center gap-4">
        <button id="timer-minus" class="px-3 py-2 bg-gray-700 rounded text-sm">-1 min</button>
        <div class="relative flex items-center justify-center">
            <div class="w-40 h-40 sm:w-52 sm:h-52 rounded-full border-4 border-blue-400 bg-black/40 flex items-center justify-center shadow-lg">
                <div id="timer-display" class="text-4xl sm:text-5xl font-mono">--:--</div>
            </div>
        </div>
        <button id="timer-plus" class="px-3 py-2 bg-gray-700 rounded text-sm">+1 min</button>
    </div>
    <div class="pb-16 flex items-center gap-3">
        <button id="timer-toggle" class="px-4 py-2 bg-blue-700 rounded">Start</button>
        <button id="timer-reset" class="px-3 py-2 bg-gray-700 rounded">Reset</button>
    </div>
</div>
{% if session.get('user') %}
<div class="mt-8 flex justify-center">
    <button
        id="save-session-btn"
        class="px-6 py-3 bg-green-600 hover:bg-green-700 transition rounded-lg font-semibold shadow-md"
    >
        ðŸ’¾ Save Session
    </button>
</div>
{% else %}
<div class="mt-8 text-center text-sm text-gray-400">
    <a href="{{ url_for('login') }}" class="underline hover:text-blue-400">
        Log in to save this session
    </a>
</div>
{% endif %}
<section class = "relative z-10 text-center py-20">
    <div class="mb-8">
      <div class="text-6xl font-black text-blue-600 mb-2" id="punch-counter">0</div>
      <div class="text-lg text-white-600">Punches Detected</div>
      <div class="text-sm text-white-500 mt-2" id="last-punch">
        No punches yet
      </div>
    </div>
  
  <!-- EVENT LOG -->
  <div class="max-w-2xl mx-auto px-4 pb-12">
    <h3 class="text-xl font-bold mb-4">ðŸ“‹ Recent Punches</h3>
    <div id="punch-log" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
      <div class="text-red-500 text-center py-2">Waiting for punches...</div>
    </div>
  </div>

</section>
<script>

(function () {
    const dataEl = document.getElementById('session-data');
    const display = document.getElementById('timer-display');
    const toggleBtn = document.getElementById('timer-toggle');
    const resetBtn = document.getElementById('timer-reset');
    const minusBtn = document.getElementById('timer-minus');
    const plusBtn = document.getElementById('timer-plus');

    
    const title = dataEl.dataset.title;
    const description = dataEl.dataset.desc;
    const focus = dataEl.dataset.focus;

    const parseSeconds = (durationStr) => {
        if (!durationStr) return 0;
        const match = durationStr.match(/([\d.]+)\s*(min|minute|minutes)?/i);
        if (!match) return 0;
        return Math.round(parseFloat(match[1]) * 60);
    };

    let totalSeconds = parseSeconds(dataEl.dataset.duration);
    let remaining = totalSeconds;
    let timerId = null;

    const format = (s) => {
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const sec = (s % 60).toString().padStart(2, '0');
        return `${m}:${sec}`;
    };

    const render = () => display.textContent = format(remaining);

    const stop = () => {
        if (timerId) clearInterval(timerId);
        timerId = null;
        toggleBtn.textContent = 'Start';
    };

    const tick = () => {
        if (remaining <= 0) return stop();
        remaining--;
        render();
    };

    toggleBtn.addEventListener('click', () => {
        if (timerId) return stop();
        timerId = setInterval(tick, 1000);
        toggleBtn.textContent = 'Pause';
    });

    resetBtn.addEventListener('click', () => {
        stop();
        remaining = totalSeconds;
        render();
    });

    minusBtn.addEventListener('click', () => {
        totalSeconds = Math.max(0, totalSeconds - 60);
        remaining = Math.max(0, remaining - 60);
        render();
    });

    plusBtn.addEventListener('click', () => {
        totalSeconds += 60;
        remaining += 60;
        render();
    });

    render();

    // âœ… SAVE SESSION BUTTON
    const saveBtn = document.getElementById("save-session-btn");
    if (saveBtn) {
        saveBtn.addEventListener("click", () => {
            fetch("/api/sessions/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    focus: focus,
                    minutes: Math.round(totalSeconds / 60)
                })
            })
            .then(res => {
                if (!res.ok) throw new Error("Save failed");
                return res.json();
            })
            .then(() => alert("Session saved!"))
            .catch(err => {
                console.error(err);
                alert("Save failed");
            });
        });
    }
})();



/* =====================================================
   PUNCH COUNTER (PubNub hook-ready)
===================================================== */
let punchCount = 0;

function incrementCounter() {
    punchCount++;
    document.getElementById('punch-counter').textContent = punchCount;

    const now = new Date();
    document.getElementById('last-punch').textContent =
        `Last punch: ${now.toLocaleTimeString()}`;

    addToLog(now);
}

function addToLog(timestamp) {
    const log = document.getElementById('punch-log');
    const entry = document.createElement('div');

    entry.className = 'border-l-4 border-red-500 pl-3 py-1';
    entry.innerHTML = `
        <div class="font-medium">ðŸ¥Š Punch #${punchCount}</div>
        <div class="text-sm text-gray-500">${timestamp.toLocaleTimeString()}</div>
    `;

    if (log.firstChild?.textContent.includes('Waiting')) {
        log.innerHTML = '';
    }

    log.prepend(entry);

    if (log.children.length > 10) {
        log.removeChild(log.lastChild);
    }
}



</script>


{% endblock %}